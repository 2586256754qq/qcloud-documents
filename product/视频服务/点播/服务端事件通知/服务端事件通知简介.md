## 事件通知简介

在某些事件发生，或者异步任务执行完毕之后，点播服务端可以将此类事件通知到APP的客户端。目前点播系统支持的事件通知包括：

| 事件类型（event_type） | 事件说明 |
|---------|---------|
| new-file-upload | 视频上传完成 |
| pull-complete | URL转拉完成 |
| transcode-complete | 视频转码完成 |
| concat-complete | 视频拼接完成 |

点播支持APP通过两种方式来获取事件通知：

- HTTP回调；
- 基于消息队列的可靠通知。

两种方式相比，前者配置简单；后者安全性高、可靠性强，但配置略为复杂。

## 配置事件通知
TODO

## HTTP回调

HTTP回调的基本流程是：APP后台搭建一个HTTP服务器来接收回调，并在点播控制台上配置回调URL；当事件发生时，点播服务端会向该URL发起HTTP POST请求，具体事件内容将通过HTTP Body送达APP后台。

TODO：流程图。

### 回调协议
请求：HTTP POST请求，包体内容为JSON，每一种回调的具体包体内容参见各自文档。
应答：点播服务端忽略应答包内容。

### 公共参数说明

| 参数名称 | 类型 | 说明 |
|---------|---------|---------|
| version | Integer | 回调版本号，固定为4 |
| event_type | String | 事件类型，APP后台可以根据该字段区分不同的回调 |
| data | Object | 具体回调数据 |
| data.status | Integer | 错误码, 0: 成功, 其他值: 失败 |
| data.message | String | 错误信息  |

### 回调请求示例

```
POST /path/to/your/service
HOST: www.example.com

```javascript
{
    "version" : 4,
    "event_type": "concat-complete",
    "data": {
        "status" : 0,
        "message" : "",
        "vod_task_id": "concat-1edb7eb88a599d05abe451cfc541cfbd",
        "file_info": [
            {
                "file_id": "14508071098244931831",
                "file_url": "http://125xx.vod2.myqcloud.com/vod125xx/14508071098244931831/playlist.f6.m3u8",
                "file_type": "m3u8"
            },
            {
                "file_id": "14508071098244929440",
                "file_url": "http://125xx.vod2.myqcloud.com/vod125xx/14508071098244929440/f0.mp4",
                "file_type": "mp4"
            }
        ]
    }
}
```

### 回调应答示例

对于HTTP回调，APP后台需要对回调请求进行应答，点播后台会忽略HTTP返回码与包体。示例如下：

```
HTTP/1.1 200 OK
Server: nginx/1.7.10
Date: Fri, 09 Oct 2015 02:59:55 GMT
Content-Length: 4

{
}
```

### 回调超时时间与重试
点播服务端发起HTTP回调的超时时间为5秒。如果回调超时，点播后台会重试两次。如果您对回调的可靠性十分敏感，建议使用基于消息队列的可靠回调。

### 安全考虑
为确保安全，APP可以将回调URL设置为HTTPS。此种方案的安全性可以达到：
- 点播服务端能够认证APP回调URL的合法性；
- 回调数据无法被人监听。

安全性无法达到：
- APP后台服务器无法认证请求方是否为点播服务端。

如果您需要更高的安全强度，建议使用基于消息队列的可靠回调。

## 基于消息队列的可靠回调

APP服务端可能会遭遇网络问题或者宕机等故障。简单HTTP回调，即时增加重试，也无法确保可靠性。为确保回调的可靠性，点播提供了第二种回调方式：基于消息队列的可靠回调。另外，此种回调方案的安全性更高。

### 基本原理介绍

- 点播后台会为APP维护一个消息队列，并扮演生产者的角色。当新的事件产生时，点播后台会将该消息放入消息队列中。
- APP后台扮演消费者的角色，需要通过长轮询的方式来获取消息队列中的内容。所谓长轮询，即：APP后台必须通过循环调用PullVodEvent接口来拉取事件通知。如果当前消息队列中存在消息，则该接口会立即返回；如果当前没有未消费事件通知，则点播后台会把该请求挂起，直到有新事件产生为止；每个请求最多挂起5秒。
- APP后台通过PullVodEvent拉取到消息之后，必须调用ConfirmVodEvent接口来确认该事件通知已经消费到，否则该消息可能会被再次消费。

TODO：流程图。

### 相关接口
基于消息队列的可靠回调通过两个服务端API实现，参见：
- 拉取事件通知（PullVodEvent）；
- 确认事件通知（ConfirmVodEvent）。


### 示例

1，APP后台调用PullVodEvent，来获取未消费事件通知，HTTP请求为：

```
GET /v2/index.php?Action=PullVodEvent&COMMON_PARAMS
HOST: vod.api.qcloud.com
```

2，假设当前存在未消费事件通知，服务端应答如下。其中eventList中包含了一条事件通知，其task字段的值为concatfile，表明是视频拼接回调。该事件通知的具体含义在事件通知-视频拼接完成中有详细描述。其中比较关键的字段是vodtask_id，后续的确认事件通知接口会用到

> 注意：
> 调用PullVodEvent接口，一次可能会返回多条事件通知。

```
HTTP/1.1 200 OK
Server: nginx/1.7.10
Date: Fri, 09 Oct 2015 02:59:55 GMT
Content-Length: 844

{
    "code": 0,
    "message": "",
    "eventList": [
        {
            "status": 0,
            "message": "",
            "task": "concatfile",
            "data": {
                "vodtask_id": "concat-1edb7eb88a599d05abe451cfc541cfbd",
                "fileinfo": [
                    {
                        "file_id": "14508071098244931831",
                        "file_url": "http://125xx.vod2.myqcloud.com/vod125xx/14508071098244931831/playlist.f6.m3u8",
                        "file_type": "m3u8"
                    },
                    {
                        "file_id": "14508071098244929440",
                        "file_url": "http://125xx.vod2.myqcloud.com/vod125xx/14508071098244929440/f0.mp4",
                        "file_type": "mp4"
                    }
                ]
            }
        }
    ]
}
```

3，APP后台在消费到事件通知后，调用ConfirmVodEvent接口来确认该事件通知已经收到。需要将PullVodEvent所返回vodtask_id作为参数。HTTP请求如下：

```
GET /v2/index.php?Action=ConfirmVodEvent&msgHandle.1=concat-1edb7eb88a599d05abe451cfc541cfbd&COMMON_PARAMS
HOST: vod.api.qcloud.com
```

4，点播服务端应答如下：
```
HTTP/1.1 200 OK
Server: nginx/1.7.10
Date: Fri, 09 Oct 2015 02:59:55 GMT
Content-Length: 4

{
}
```
